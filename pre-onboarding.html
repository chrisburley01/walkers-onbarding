<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Walkers Transport | Pre-Onboarding</title>

  <!-- Favicons (same as master) -->
  <link rel="icon" href="Doc/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="Doc/favicon-32x32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="Doc/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="Doc/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="Doc/android-chrome-512x512.png" sizes="512x512">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --wk-blue:#002c77; --wk-dark:#0f2353; }
    body{font-family:Arial, Helvetica, sans-serif; background:#f8fafc; color:#0b1220}
    .btn-primary{background:var(--wk-blue);color:#fff}
    .btn-primary:hover{filter:brightness(.97)}
    .btn-dark{background:var(--wk-dark);color:#fff}
    .btn-dark:hover{filter:brightness(.97)}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .focus-ring:focus{outline:3px solid rgba(0,44,119,.25);outline-offset:2px}
    .dot{width:.625rem;height:.625rem;border-radius:9999px;background:var(--wk-blue)}
    .field{display:block}
    .field input,.field select,.field textarea{margin-top:.25rem;width:100%;border:1px solid #d1d5db;border-radius:.5rem;padding:.5rem}
    .hint{font-size:.75rem;color:#6b7280}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="text-white shadow-md" style="background:#002c77">
    <div class="max-w-7xl mx-auto flex items-center gap-4 px-6 py-3">
      <img src="assets/walkers-logo.png" alt="Walkers Transport" class="h-16 w-auto select-none brightness-110 drop-shadow-md">
      <div>
        <h1 class="text-2xl font-extrabold leading-tight">Walkers Transport</h1>
        <p class="text-white/80 text-sm -mt-0.5">Can Do. Pre-Onboarding</p>
      </div>
      <nav class="hidden md:flex gap-4 text-sm ml-auto">
        <a href="#opportunity" class="hover:underline">Opportunity</a>
        <a href="#crm" class="hover:underline">CRM Entry</a>
        <a href="#creditsafe" class="hover:underline">CreditSafe</a>
        <a href="#factfind" class="hover:underline">Fact-Find</a>
        <a href="#ratesent" class="hover:underline">Rate Sent</a>
        <a href="#negotiation" class="hover:underline">Negotiation</a>
        <a href="#depot" class="hover:underline">Depot Sign-off</a>
        <a href="#cfo" class="hover:underline">CFO Sign-off</a>
      </nav>
    </div>
  </header>

  <!-- STATUS BAR -->
  <section class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center gap-3 text-sm">
      <span class="dot"></span><span class="font-medium">Status:</span>
      <span id="statusLabel" class="text-gray-600">Opportunity</span>
      <span class="mx-2 text-gray-300">|</span>
      <button id="saveBtn" class="px-3 py-1.5 rounded-lg btn-dark text-xs font-semibold">Save Progress</button>
      <button id="previewBtn" class="px-3 py-1.5 rounded-lg border text-xs font-semibold">Preview JSON</button>
      <button id="exportBtn" class="px-3 py-1.5 rounded-lg border text-xs font-semibold">Download JSON</button>
    </div>
  </section>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid lg:grid-cols-12 gap-8">

      <!-- Steps -->
      <aside class="lg:col-span-4 xl:col-span-3">
        <div class="bg-white rounded-2xl shadow-soft p-5 sticky top-6">
          <h2 class="text-lg font-bold mb-4">Pre-Onboarding Steps</h2>
          <ol class="space-y-2 text-sm" id="stepsList">
            <li data-step="opportunity" class="border rounded-xl p-3 cursor-pointer">1. Opportunity</li>
            <li data-step="crm"        class="border rounded-xl p-3 cursor-pointer">2. CRM Entry</li>
            <li data-step="creditsafe" class="border rounded-xl p-3 cursor-pointer">3. CreditSafe</li>
            <li data-step="factfind"   class="border rounded-xl p-3 cursor-pointer">4. Fact-Find</li>
            <li data-step="ratesent"   class="border rounded-xl p-3 cursor-pointer">5. Rate Sent</li>
            <li data-step="negotiation"class="border rounded-xl p-3 cursor-pointer">6. Negotiation</li>
            <li data-step="depot"      class="border rounded-xl p-3 cursor-pointer">7. Depot Manager Sign-off</li>
            <li data-step="cfo"        class="border rounded-xl p-3 cursor-pointer">8. CFO Sign-off</li>
          </ol>
          <p class="mt-6 text-xs text-gray-500">Capture key info before full onboarding.</p>
        </div>
      </aside>

      <!-- Panels -->
      <section class="lg:col-span-8 xl:col-span-9 space-y-8">

        <!-- 1. Opportunity -->
        <div id="opportunity" class="bg-white rounded-2xl shadow-soft p-6">
          <h2 class="text-2xl font-extrabold mb-2">1. Opportunity</h2>
          <p class="text-gray-600 mb-4">Lead identified and qualified. Confirm intent to proceed to commercial due diligence.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">Company Name<input name="opp_company"/></label>
            <label class="field text-sm">Company Reg (optional)<input name="opp_reg"/></label>
            <label class="field text-sm">Primary Contact<input name="opp_contact"/></label>
            <label class="field text-sm">Email<input type="email" name="opp_email"/></label>
            <label class="field text-sm">Phone<input name="opp_phone"/></label>
            <label class="field text-sm">Sector<select name="opp_sector">
              <option value="">Select…</option><option>Manufacturing</option><option>Retail</option><option>FMCG</option><option>eCommerce</option><option>Other</option>
            </select></label>
            <label class="field text-sm md:col-span-2">Notes<textarea rows="3" name="opp_notes"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-next="crm" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 2. CRM Entry -->
        <div id="crm" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">2. CRM Entry</h2>
          <p class="text-gray-600 mb-4">Create/verify account in CRM with basic company/contact details.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">CRM Account ID<input name="crm_id"/></label>
            <label class="field text-sm">CRM Stage<select name="crm_stage">
              <option value="">Select…</option><option>Prospect</option><option>Qualified</option><option>Proposal</option><option>Verbal Win</option>
            </select></label>
            <label class="field text-sm">Account Created (date)<input type="date" name="crm_created"/></label>
            <label class="field text-sm">Invoice Email<input type="email" name="crm_invoice_email"/></label>
            <label class="inline-flex items-start gap-2 text-sm md:col-span-2">
              <input type="checkbox" name="crm_contacts_ok"> <span>Key contacts confirmed (Sales, Ops, Accounts)</span>
            </label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="opportunity" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="creditsafe" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 3. CreditSafe (with link + open button) -->
        <div id="creditsafe" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">3. CreditSafe</h2>
          <p class="text-gray-600 mb-4">Perform initial credit check and risk assessment.</p>
          <div class="grid md:grid-cols-3 gap-6">
            <label class="field text-sm">Credit Score (0–100)<input type="number" min="0" max="100" name="cs_score"/></label>
            <label class="field text-sm">Recommended Limit (£)<input type="number" step="1" name="cs_limit"/></label>
            <label class="field text-sm">Decision<select name="cs_decision">
              <option value="">Select…</option><option>Approve</option><option>Refer</option><option>Decline</option>
            </select></label>

            <!-- NEW: CreditSafe link -->
            <label class="field text-sm md:col-span-2">CreditSafe Report URL
              <input type="url" name="cs_link" placeholder="https://app.creditsafe.com/...">
              <span class="hint">Paste the direct report link for quick access.</span>
            </label>
            <div class="md:col-span-1 flex items-end">
              <button id="csOpenBtn" type="button" class="w-full px-4 py-2 rounded-xl border font-semibold">Open CreditSafe</button>
            </div>

            <label class="field text-sm md:col-span-3">Notes<textarea rows="3" name="cs_notes"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="crm" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="factfind" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 4. Fact-Find (with Collection Type) -->
        <div id="factfind" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">4. Fact-Find</h2>
          <p class="text-gray-600 mb-4">Capture operational requirements for commercial proposal.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">Expected Monthly Pallets<input type="number" name="ff_pallets"/></label>
            <label class="field text-sm">Full Pallets %<input type="number" step="1" name="ff_full_pct"/></label>

            <!-- NEW: Collection Type -->
            <label class="field text-sm">Collection Type
              <select name="ff_collection_type">
                <option value="">Select…</option>
                <option>Ad-hoc</option>
                <option>Scheduled Daily</option>
                <option>Scheduled Weekly</option>
                <option>Call-off</option>
              </select>
            </label>

            <fieldset>
              <legend class="text-sm font-semibold mb-2">Services Required</legend>
              <div class="grid md:grid-cols-3 gap-3 text-sm">
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_nextday"> Next Day</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_economy"> Economy</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_timed"> Timed</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_pre10"> Pre-10</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_taillift"> Tail Lift</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="ff_adr"> ADR (LQ)</label>
              </div>
            </fieldset>

            <label class="field text-sm md:col-span-2">Main Origins/Destinations (lanes)
              <textarea rows="3" name="ff_lanes" placeholder="e.g., Leeds → Glasgow, Manchester → Bristol"></textarea>
            </label>
            <label class="field text-sm">Collection Window<input name="ff_collection_window" placeholder="e.g., 08:00–12:00"/></label>
            <label class="field text-sm">Delivery Window<input name="ff_delivery_window" placeholder="e.g., 08:00–17:00"/></label>
            <label class="field text-sm md:col-span-2">Site Restrictions / Instructions<textarea rows="3" name="ff_site"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="creditsafe" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="ratesent" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 5. Rate Sent -->
        <div id="ratesent" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">5. Rate Sent</h2>
          <p class="text-gray-600 mb-4">Issue rate card/proposal to customer.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">Rate Card Version<input name="rs_version"/></label>
            <label class="field text-sm">Date Sent<input type="date" name="rs_date"/></label>
            <label class="field text-sm">Method<select name="rs_method">
              <option value="">Select…</option><option>Email</option><option>In-person Meeting</option><option>Video Call</option>
            </select></label>
            <label class="field text-sm">Valid Until<input type="date" name="rs_valid"/></label>
            <label class="field text-sm md:col-span-2">Notes<textarea rows="3" name="rs_notes"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="factfind" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="negotiation" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 6. Negotiation -->
        <div id="negotiation" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">6. Negotiation</h2>
          <p class="text-gray-600 mb-4">Agree final commercials and service scope.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm md:col-span-2">Concessions / Changes<textarea rows="3" name="neg_changes"></textarea></label>
            <label class="field text-sm">Revised Rates Sent (date)<input type="date" name="neg_rev_date"/></label>
            <label class="field text-sm">Competitor / Benchmark<input name="neg_comp"/></label>
            <label class="field text-sm md:col-span-2">Final Agreed Headline<textarea rows="2" name="neg_headline" placeholder="e.g., Full pallet £X, Half £Y, Fuel Surcharge via AA diesel avg"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="ratesent" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="depot" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 7. Depot Manager Sign-off -->
        <div id="depot" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">7. Depot Manager Sign-off</h2>
          <p class="text-gray-600 mb-4">Depot reviews operational fit and confirms readiness.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">Depot Name<input name="dep_name" placeholder="Leeds / Manchester / Stoke"/></label>
            <label class="field text-sm">Manager Name<input name="dep_manager"/></label>
            <label class="field text-sm">Sign-off Date<input type="date" name="dep_date"/></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" name="dep_capacity_ok"> <span>Capacity & resources confirmed (vehicles, drivers, trunking, network)</span></label>
            <label class="field text-sm md:col-span-2">Equipment / Special Requirements<textarea rows="2" name="dep_equipment" placeholder="e.g., regular tail lift, booking-in, timed windows"></textarea></label>
          </div>
          <div class="mt-6 flex gap-2">
            <button data-prev="negotiation" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button data-next="cfo" class="px-4 py-2 rounded-xl btn-primary font-semibold">Next</button>
          </div>
        </div>

        <!-- 8. CFO Sign-off -->
        <div id="cfo" class="bg-white rounded-2xl shadow-soft p-6 hidden">
          <h2 class="text-2xl font-extrabold mb-2">8. CFO Sign-off</h2>
          <p class="text-gray-600 mb-4">Final commercial approval. Proceed to full onboarding.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <label class="field text-sm">CFO / Approver Name<input name="cfo_name"/></label>
            <label class="field text-sm">Approval Date<input type="date" name="cfo_date"/></label>
            <label class="field text-sm">Approved Credit Limit (£)<input type="number" step="1" name="cfo_limit"/></label>
            <label class="field text-sm">Payment Terms<select name="cfo_terms">
              <option>30 days EOM</option><option>14 days</option><option>7 days</option><option>Pro-forma</option>
            </select></label>
            <label class="field text-sm md:col-span-2">Approval Notes<textarea rows="3" name="cfo_notes"></textarea></label>
            <label class="inline-flex items-start gap-2 text-sm md:col-span-2">
              <input type="checkbox" name="cfo_ready"> <span>Approved to proceed to full onboarding</span>
            </label>
          </div>
          <div class="mt-6 flex flex-wrap gap-3">
            <button data-prev="depot" class="px-4 py-2 rounded-xl border font-semibold">Back</button>
            <button id="downloadBtn" class="px-4 py-2 rounded-xl btn-primary font-semibold">Download JSON</button>
          </div>
          <pre id="jsonPreview" class="mt-6 p-4 bg-gray-50 border rounded-xl overflow-auto text-xs hidden"></pre>
          <p class="hint mt-2">Tip: after downloading JSON, move on to your main onboarding page.</p>
        </div>

      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-xs text-gray-500">
    © <span id="year"></span> Walkers Transport — Howley Park Road East, Morley, Leeds LS27 0BN · 0113 220 2800 ·
    <a class="underline" href="mailto:info@walkers-transport.co.uk">info@walkers-transport.co.uk</a>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Step order & references
    const order = ['opportunity','crm','creditsafe','factfind','ratesent','negotiation','depot','cfo'];
    const panels = Object.fromEntries(order.map(id => [id, document.getElementById(id)]));
    const stepsList = document.getElementById('stepsList');

    function show(id){
      order.forEach(k => panels[k].classList.toggle('hidden', k!==id));
      Array.from(stepsList.children).forEach((li, idx) => {
        const active = order[idx]===id;
        li.classList.toggle('ring-2', active);
        li.classList.toggle('ring-blue-800', active);
        li.classList.toggle('bg-blue-50', active);
      });
      const h = panels[id].querySelector('h2')?.textContent ?? id;
      document.getElementById('statusLabel').textContent = h.replace(/^[0-9]+\\.\\s*/,'');
      location.hash = id;
      localStorage.setItem('walkers_pre_onboarding_step', id);
    }

    // Navigation buttons
    document.querySelectorAll('[data-next]').forEach(b=>b.addEventListener('click', ()=>show(b.dataset.next)));
    document.querySelectorAll('[data-prev]').forEach(b=>b.addEventListener('click', ()=>show(b.dataset.prev)));

    // Sidebar clicks
    stepsList.addEventListener('click', e=>{
      const li = e.target.closest('li[data-step]'); if(li) show(li.dataset.step);
    });

    // Collect all inputs across panels
    function collect(){
      const data = {};
      document.querySelectorAll('input, select, textarea').forEach(el=>{
        if(!el.name) return;
        if(el.type==='checkbox') data[el.name] = !!el.checked;
        else data[el.name] = el.value;
      });
      data._current_step = location.hash.substring(1) || 'opportunity';
      data._saved_at = new Date().toISOString();
      return data;
    }

    // Save / Preview / Download
    document.getElementById('saveBtn').addEventListener('click', ()=>{
      localStorage.setItem('walkers_pre_onboarding_form', JSON.stringify(collect()));
      document.getElementById('statusLabel').textContent = 'Saved locally';
    });

    document.getElementById('previewBtn').addEventListener('click', ()=>{
      const pre = document.getElementById('jsonPreview') || panels.cfo.querySelector('#jsonPreview');
      pre.textContent = JSON.stringify(collect(), null, 2);
      pre.classList.remove('hidden');
      show('cfo'); // show preview in a consistent place
    });

    const saveBlob = (obj, name) => {
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('exportBtn').addEventListener('click', ()=> saveBlob(collect(),'walkers-pre-onboarding.json'));
    document.getElementById('downloadBtn')?.addEventListener('click', ()=> saveBlob(collect(),'walkers-pre-onboarding.json'));

    // Restore saved values (if any)
    (function restore(){
      const saved = localStorage.getItem('walkers_pre_onboarding_form');
      if(saved){
        try{
          const data = JSON.parse(saved);
          Object.entries(data).forEach(([k,v])=>{
            const el = document.querySelector(`[name="${CSS.escape(k)}"]`);
            if(!el) return;
            if(el.type==='checkbox') el.checked = !!v;
            else el.value = v;
          });
        }catch{}
      }
      const stepSaved = localStorage.getItem('walkers_pre_onboarding_step');
      const initial = location.hash.substring(1) || stepSaved || 'opportunity';
      show(order.includes(initial)?initial:'opportunity');
    })();

    window.addEventListener('hashchange', ()=> show(location.hash.substring(1) || 'opportunity'));

    // NEW: CreditSafe quick open
    document.getElementById('csOpenBtn')?.addEventListener('click', ()=>{
      const url = document.querySelector('[name="cs_link"]')?.value?.trim();
      if (url) { window.open(url, '_blank', 'noopener'); }
      else { alert('Add a CreditSafe report URL first.'); }
    });
  </script>
</body>
</html>